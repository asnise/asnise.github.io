<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Item JSON Studio</title>
  <style>
    :root{
      --bg: #f7f8fa;
      --panel: #ffffff;
      --ink: #1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#4f46e5;
      --primary-ink:#fff;
      --danger:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
      --chip:#eef2ff;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Thai Sans Serif", "Noto Sans Thai", Arial, "Helvetica Neue";
    }
    header{
      position:sticky; top:0; z-index:10;
      background:var(--panel); border-bottom:1px solid var(--line);
    }
    .topbar{
      max-width:1200px; margin:auto; padding:10px 16px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .brand{font-weight:700; margin-right:auto}
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:8px 12px; border-radius:10px; cursor:pointer; transition:.15s;
      display:inline-flex; align-items:center; gap:.5rem; white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--primary); color:var(--primary-ink); border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger); color:#fff; border-color:transparent}
    input[type="file"]{display:none}
    .hotkey{font: 12px/1 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#f3f4f6; border:1px solid var(--line); border-radius:6px; padding:2px 6px}

    main{max-width:1200px; margin:14px auto; padding:0 16px; display:grid; grid-template-columns: 300px 1fr; gap:14px}
    .panel{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); overflow:hidden}
    .panel-head{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:8px}
    .panel-body{padding:14px}
    .row{display:grid; grid-template-columns: 140px 1fr; gap:10px; align-items:center; margin-bottom:10px}
    .row textarea{min-height:90px; resize:vertical}
    .row input[type="text"], .row input[type="number"], .row select{
      width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff; color:var(--ink);
    }

    /* Sidebar list */
    .list-tools{display:flex; gap:8px; padding:8px 14px; border-bottom:1px solid var(--line); align-items:center; flex-wrap:wrap}
    .search{flex:1; display:flex; gap:8px}
    .search input{flex:1; border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff}
    .filters{display:flex; gap:6px; flex-wrap:wrap}
    .chip{background:var(--chip); color:#3730a3; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #dfe3ff; cursor:pointer}
    .list{max-height:70vh; overflow:auto}
    .item{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; border-bottom:1px solid var(--line); cursor:pointer; background:#fff;
    }
    .item:hover{background:#fafafa}
    .item.active{background:#eef2ff}
    .item .meta{font-size:12px; color:var(--muted)}
    .sort{margin-left:auto}

    /* Crafting table */
    table{width:100%; border-collapse:collapse; border:1px solid var(--line); border-radius:10px; overflow:hidden}
    th,td{border-bottom:1px solid var(--line); padding:8px; text-align:left}
    th{background:#fafafa; font-weight:600}
    .table-actions{display:flex; gap:6px}
    .muted{color:var(--muted)}

    /* Preview + JSON */
    .preview{
      display:flex; align-items:center; gap:10px; padding:8px; border:1px dashed var(--line); border-radius:10px; background:#fafafa;
    }
    .preview img{width:44px; height:44px; object-fit:contain; border-radius:8px; background:#fff; border:1px solid var(--line)}
    .json-box{
      width:100%; min-height:200px; background:#0b1020; color:#e5e7eb; border-radius:12px; padding:12px; font: 12px/1.6 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      overflow:auto; border:1px solid #111827;
    }

    /* Footer tips */
    .tips{display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:#374151}

    /* Toast */
    .toast{position:fixed; right:14px; bottom:14px; display:flex; flex-direction:column; gap:8px; z-index:20}
    .toast .t{background:#111827; color:#e5e7eb; padding:10px 12px; border-radius:10px; border:1px solid #374151}
    .badge{font:12px/1 ui-monospace,monospace; background:#f3f4f6; border:1px solid var(--line); border-radius:6px; padding:2px 6px}

    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      .row{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">üß™ Item JSON Studio</div>
    <label class="btn">
      <input id="importFile" type="file" accept=".json" />
      ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ JSON
    </label>
    <button id="btnNew" class="btn">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà <span class="hotkey">Ctrl+N</span></button>
    <button id="btnDup" class="btn">‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</button>
    <button id="btnDel" class="btn danger">‡∏•‡∏ö</button>
    <span style="flex:1"></span>
    <button id="btnValidate" class="btn">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
    <button id="btnPreview" class="btn ghost">‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô JSON</button>
    <button id="btnCopy" class="btn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON <span class="hotkey">Ctrl+S</span></button>
    <button id="btnDownload" class="btn primary">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
  </div>
</header>

<main>
  <!-- Sidebar -->
  <section class="panel" id="sidebar">
    <div class="list-tools">
      <div class="search">
        <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (ID/‡∏ä‡∏∑‡πà‡∏≠)..." />
        <select id="sort" class="row select">
          <option value="id-asc">ID ‚¨Ü</option>
          <option value="id-desc">ID ‚¨á</option>
          <option value="name-asc">Name ‚¨Ü</option>
          <option value="name-desc">Name ‚¨á</option>
          <option value="price-asc">Price ‚¨Ü</option>
          <option value="price-desc">Price ‚¨á</option>
        </select>
      </div>
      <div class="filters">
        <label><input type="checkbox" id="flt-misc" checked/> <span class="chip">Miscellaneous</span></label>
        <label><input type="checkbox" id="flt-consum" checked/> <span class="chip">Consumable</span></label>
      </div>
    </div>
    <div class="list" id="itemList"></div>
  </section>

  <!-- Editor -->
  <section class="panel" id="editor">
    <div class="panel-head">
      <strong id="title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢</strong>
      <span class="badge" id="dirty" style="display:none">Unsaved*</span>
      <span style="margin-left:auto" class="muted" id="countInfo"></span>
    </div>
    <div class="panel-body" id="editorBody" style="display:none">
      <!-- ID ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
      <div class="row">
        <label>ID</label>
        <div id="f-id-text" class="badge" style="padding:8px 10px;border-radius:10px;background:#f3f4f6;border:1px solid var(--line)">
          #
        </div>
      </div>

      <div class="row"><label>Item Name</label> <input id="f-name" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô Potion" /></div>
      <div class="row"><label>Price</label> <input id="f-price" type="number" min="0" step="1" /></div>
      <div class="row"><label>Category</label>
        <select id="f-cat">
          <option>Miscellaneous</option>
          <option>Consumable</option>
        </select>
      </div>
      <div class="row"><label>Stack</label> <input id="f-stack" type="number" min="1" step="1" /></div>
      <div class="row"><label>Stack Count</label> <input id="f-stackCnt" type="number" min="1" step="1" /></div>
      <div class="row"><label>Description</label> <textarea id="f-desc" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"></textarea></div>
      <div class="row"><label>Sprite URL</label> <input id="f-sprite" type="text" placeholder="(‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ)"/></div>
      <div class="row"><label>Preview</label>
        <div class="preview">
          <img id="spritePreview" alt="">
          <div class="muted">*Sprite ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö Loader ‡πÉ‡∏ô Unity)</div>
        </div>
      </div>

      <h3 style="margin:18px 0 8px">Crafting Resources</h3>
      <table>
        <thead>
          <tr><th style="width:30%">AtomNumber</th><th style="width:30%">StackCount</th><th>Action</th></tr>
        </thead>
        <tbody id="tblCraft"></tbody>
      </table>
      <div style="margin-top:8px">
        <button class="btn" id="btnAddRes">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</button>
      </div>

      <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn primary" id="btnApply">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button class="btn" id="btnGenerate">‡πÅ‡∏™‡∏î‡∏á JSON ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </div>

    <div class="panel-body" id="jsonPanel" style="display:none">
      <div class="json-box" id="output">{}</div>
      <div class="tips" style="margin-top:8px">
        <div>‡∏ä‡πá‡∏≠‡∏ï‡∏Ñ‡∏±‡∏ï: <span class="hotkey">Ctrl+S</span> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON, <span class="hotkey">Ctrl+N</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      </div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
/** -----------------------
 * State
 * ----------------------*/
let items = [];          // working array
let selected = -1;       // index in items
let dirty = false;

/** -----------------------
 * Helpers
 * ----------------------*/
const $ = (id)=>document.getElementById(id);
const toast = (msg)=> {
  const t = document.createElement("div");
  t.className="t"; t.textContent = msg;
  $("toast").appendChild(t);
  setTimeout(()=> t.remove(), 2000);
};
const clampInt = (v, min=0)=> isNaN(parseInt(v)) ? min : Math.max(min, parseInt(v));
const deepClone = (o)=> JSON.parse(JSON.stringify(o));
const byId = (arr,id)=> arr.findIndex(x=> x.id===id);

/** -----------------------
 * Normalizer/Validator
 * ----------------------*/
function normalizeItem(x){
  return {
    id: clampInt(x.id, nextId()),
    itemName: (x.itemName||"").toString(),
    price: clampInt(x.price, 0),
    description: (x.description||"").toString(),
    category: (x.category==="Consumable") ? "Consumable" : "Miscellaneous",
    stack: Math.max(1, clampInt(x.stack, 1)),
    stackCount: Math.max(1, clampInt(x.stackCount, 1)),
    crafting_resources: Array.isArray(x.crafting_resources) ? x.crafting_resources.map(r=>({
      AtomNumber: clampInt(r.AtomNumber, 0),
      StackCount: Math.max(1, clampInt(r.StackCount, 1))
    })) : [],
    // sprite is local-only (not exported)
    sprite: (x.sprite||"").toString()
  };
}
function normalizeArray(arr){
  const out = arr.map(normalizeItem);
  // ensure unique ids
  const used = new Set();
  for(const it of out){
    while(used.has(it.id)) it.id++;
    used.add(it.id);
  }
  return out;
}
function validateAll(){
  const ids = new Set();
  for(const it of items){
    if(ids.has(it.id)) return {ok:false, msg:`‡∏û‡∏ö ID ‡∏ã‡πâ‡∏≥: ${it.id}`};
    ids.add(it.id);
    if(it.itemName.trim()==="") return {ok:false, msg:`‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏á (ID: ${it.id})`};
    if(it.price<0) return {ok:false, msg:`‡∏£‡∏≤‡∏Ñ‡∏≤ < 0 (ID: ${it.id})`};
    for(const r of it.crafting_resources){
      if(r.StackCount<=0) return {ok:false, msg:`StackCount ‡∏ï‡πâ‡∏≠‡∏á > 0 (ID: ${it.id})`};
    }
  }
  return {ok:true, msg:`‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`};
}

/** -----------------------
 * ID helpers
 * ----------------------*/
function nextId(){
  return items.length ? Math.max(...items.map(x=> x.id||0))+1 : 1;
}
function reIdSequential(){
  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ID ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠: 1..N ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  for(let i=0;i<items.length;i++){
    items[i].id = i+1;
  }
}

/** -----------------------
 * Sidebar rendering
 * ----------------------*/
function renderList(){
  const q = $("q").value.toLowerCase().trim();
  const showMisc = $("flt-misc").checked, showConsum = $("flt-consum").checked;
  const sort = $("sort").value;

  let view = items.map((x,i)=> ({...x, __i:i}));
  if(q){
    view = view.filter(x=> (""+x.id).includes(q) || x.itemName.toLowerCase().includes(q));
  }
  view = view.filter(x=> (x.category==="Miscellaneous" && showMisc) || (x.category==="Consumable" && showConsum));

  const key = sort.split("-")[0], dir = sort.endsWith("desc")? -1: 1;
  view.sort((a,b)=> (a[key] > b[key] ? 1 : a[key] < b[key] ? -1 : 0)*dir);

  const root = $("itemList"); root.innerHTML="";
  view.forEach((x)=>{
    const el = document.createElement("div");
    el.className="item"+(x.__i===selected?" active":"");
    el.draggable = true;
    el.addEventListener("dragstart", (ev)=>{ ev.dataTransfer.setData("text/plain", x.__i);});
    el.addEventListener("dragover",(ev)=> ev.preventDefault());
    el.addEventListener("drop",(ev)=>{
      ev.preventDefault();
      const from = parseInt(ev.dataTransfer.getData("text/plain"),10);
      const to = x.__i;
      if(!isNaN(from) && from!==to){
        const mv = items.splice(from,1)[0];
        items.splice(to,0,mv);
        markDirty(); renderList();
      }
    });

    el.innerHTML = `
      <div>
        <div><strong>#${x.id}</strong> ${escapeHtml(x.itemName)}</div>
        <div class="meta">${x.category} ‚Ä¢ ${x.price}G ‚Ä¢ ${x.crafting_resources.length} res</div>
      </div>
      <div class="meta">stk:${x.stack}/${x.stackCount}</div>
    `;
    el.onclick = ()=> { selected = x.__i; openEditor(items[selected]); highlightTitle(); $("editorBody").style.display="block"; renderCraft(); };
    root.appendChild(el);
  });

  $("countInfo").textContent = `${items.length} items`;
}

/** -----------------------
 * Editor binding
 * ----------------------*/
function openEditor(it){
  $("f-id-text").textContent = `#${it.id}`;   // ID ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  $("f-name").value = it.itemName;
  $("f-price").value = it.price;
  $("f-cat").value = it.category;
  $("f-stack").value = it.stack;
  $("f-stackCnt").value = it.stackCount;
  $("f-desc").value = it.description;
  $("f-sprite").value = it.sprite||"";
  updateSpritePreview();
  $("title").textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: #${it.id} ‚Ä¢ ${it.itemName||"(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)"}`;
}
function gatherEditor(){
  // ‡πÉ‡∏ä‡πâ id ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏°‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ)
  const id = (selected >= 0) ? items[selected].id : nextId();
  const draft = normalizeItem({
    id,
    itemName: $("f-name").value,
    price: parseInt($("f-price").value,10),
    category: $("f-cat").value,
    stack: parseInt($("f-stack").value,10),
    stackCount: parseInt($("f-stackCnt").value,10),
    description: $("f-desc").value,
    sprite: $("f-sprite").value,
    crafting_resources: currentCraftRows()
  });
  return draft;
}
function applyEditor(){
  if(selected<0) return;
  const draft = gatherEditor();
  // ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡πâ‡∏≠‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç id ‡πÄ‡∏î‡∏¥‡∏°
  items[selected] = draft;
  markDirty();
  renderList();
  toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå)");
}
function markDirty(){
  dirty=true; $("dirty").style.display="inline-block";
}
function clearDirty(){
  dirty=false; $("dirty").style.display="none";
}
function highlightTitle(){
  $("title").style.animation="hl .8s";
  setTimeout(()=>$("title").style.animation="", 900);
}
function updateSpritePreview(){
  const url = $("f-sprite").value.trim();
  $("spritePreview").src = url || "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
}

/** Crafting grid */
function renderCraft(){
  const it = items[selected];
  const tb = $("tblCraft"); tb.innerHTML="";
  it.crafting_resources.forEach((r, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="number" min="0" value="${r.AtomNumber}" data-k="AtomNumber" data-i="${idx}"></td>
      <td><input type="number" min="1" value="${r.StackCount}" data-k="StackCount" data-i="${idx}"></td>
      <td class="table-actions"><button class="btn" data-act="up" data-i="${idx}">‚Üë</button>
          <button class="btn" data-act="down" data-i="${idx}">‚Üì</button>
          <button class="btn danger" data-act="del" data-i="${idx}">‡∏•‡∏ö</button></td>
    `;
    tb.appendChild(tr);
  });

  // bind change
  tb.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", (e)=>{
      const i = parseInt(e.target.getAttribute("data-i"),10);
      const k = e.target.getAttribute("data-k");
      items[selected].crafting_resources[i][k] = clampInt(e.target.value, k==="StackCount"?1:0);
      markDirty();
    });
  });
  tb.querySelectorAll("button").forEach(b=>{
    b.onclick = ()=>{
      const i = parseInt(b.getAttribute("data-i"),10), act = b.getAttribute("data-act");
      const list = items[selected].crafting_resources;
      if(act==="del"){ list.splice(i,1);}
      else if(act==="up" && i>0){ [list[i-1], list[i]] = [list[i], list[i-1]]; }
      else if(act==="down" && i<list.length-1){ [list[i+1], list[i]] = [list[i], list[i+1]]; }
      markDirty(); renderCraft();
    };
  });
}
function currentCraftRows(){
  if(selected<0) return [];
  return Array.from($("tblCraft").querySelectorAll("tr")).map(tr=>{
    const n = tr.querySelector('input[data-k="AtomNumber"]').value;
    const s = tr.querySelector('input[data-k="StackCount"]').value;
    return { AtomNumber: clampInt(n,0), StackCount: Math.max(1, clampInt(s,1)) };
  });
}

/** -----------------------
 * JSON export / preview
 * ----------------------*/
function exportPayload(){
  // Unity Loader expects these fields (no sprite)
  // id, itemName, price, description, category, stack, stackCount, crafting_resources
  const lean = items.map(x=> ({
    id:x.id, itemName:x.itemName, price:x.price, description:x.description,
    category:x.category, stack:x.stack, stackCount:x.stackCount,
    crafting_resources: x.crafting_resources.map(r=>({AtomNumber:r.AtomNumber, StackCount:r.StackCount}))
  }));
  return JSON.stringify(lean, null, 2);
}
function showPreview(toggle=true){
  if(toggle) $("jsonPanel").style.display = $("jsonPanel").style.display==="none" ? "block" : "none";
  $("output").textContent = exportPayload();
}

/** -----------------------
 * IO: import/download/copy
 * ----------------------*/
$("importFile").addEventListener("change", (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    try{
      const raw = JSON.parse(ev.target.result);
      if(!Array.isArray(raw)) throw new Error("‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á Item");

      // 1) ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏° schema
      items = normalizeArray(raw);
      // 2) ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ID ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ Import: 1..N
      reIdSequential();
      // 3) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
      selected = items.length? 0 : -1;
      clearDirty(); renderList();
      if(selected>=0){ $("editorBody").style.display="block"; openEditor(items[selected]); renderCraft(); }
      toast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ID 1..${items.length}`);
    }catch(err){
      alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+ err.message);
    }finally{
      e.target.value="";
    }
  };
  reader.readAsText(file);
});

$("btnDownload").onclick = ()=>{
  const blob = new Blob([exportPayload()], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "items.json";
  a.click();
  URL.revokeObjectURL(a.href);
  clearDirty();
  toast("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå items.json ‡πÅ‡∏•‡πâ‡∏ß");
};
$("btnCopy").onclick = ()=>{
  navigator.clipboard.writeText(exportPayload()).then(()=>{
    clearDirty(); toast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß");
  });
};

/** -----------------------
 * Commands
 * ----------------------*/
$("btnNew").onclick = ()=>{
  const it = normalizeItem({
    id: nextId(),
    itemName: "",
    price: 1,
    description:"",
    category:"Miscellaneous",
    stack:1,
    stackCount:1,
    crafting_resources:[]
  });
  items.push(it); selected = items.length-1;
  renderList(); $("editorBody").style.display="block"; openEditor(it); renderCraft(); markDirty();
};
$("btnDup").onclick = ()=>{
  if(selected<0) return;
  const du = deepClone(items[selected]);
  du.id = nextId();
  du.itemName = du.itemName ? du.itemName+" (copy)" : "(copy)";
  items.splice(selected+1, 0, du);
  selected = selected+1;
  renderList(); openEditor(du); renderCraft(); markDirty();
};
$("btnDel").onclick = ()=>{
  if(selected<0) return;
  if(confirm(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ #${items[selected].id}?`)){
    items.splice(selected,1);
    selected = Math.min(selected, items.length-1);
    renderList();
    if(selected>=0){ openEditor(items[selected]); renderCraft();}
    else{ $("editorBody").style.display="none"; $("title").textContent="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢"; }
    markDirty();
  }
};
$("btnValidate").onclick = ()=>{
  const v = validateAll();
  toast(v.msg);
  if(!v.ok) alert(v.msg);
};
$("btnPreview").onclick = ()=> showPreview(true);
$("btnGenerate").onclick = ()=> { showPreview(false); toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï JSON Preview ‡πÅ‡∏•‡πâ‡∏ß"); };
$("btnAddRes").onclick = ()=>{
  if(selected<0) return;
  items[selected].crafting_resources.push({AtomNumber:0, StackCount:1});
  renderCraft(); markDirty();
};
$("btnApply").onclick = ()=> applyEditor();

/** field change listeners (‡πÑ‡∏°‡πà‡∏°‡∏µ f-id ‡πÅ‡∏•‡πâ‡∏ß) */
["f-name","f-price","f-cat","f-stack","f-stackCnt","f-desc","f-sprite"].forEach(id=>{
  $(id).addEventListener("input", ()=> {
    if(selected>=0){ markDirty(); if(id==="f-sprite") updateSpritePreview(); }
  });
});

["q","sort","flt-misc","flt-consum"].forEach(id=> $(id).addEventListener("input", renderList));

/** keyboard shortcuts */
document.addEventListener("keydown",(e)=>{
  const mod = (e.ctrlKey||e.metaKey);
  if(mod && e.key.toLowerCase()==="s"){ e.preventDefault(); $("btnCopy").click(); }
  if(mod && e.key.toLowerCase()==="n"){ e.preventDefault(); $("btnNew").click(); }
  if(e.key==="Delete"){ $("btnDel").click(); }
});

/** escape HTML for list rendering */
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
}

/** boot */
(function init(){
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á ‡πÜ (‡πÑ‡∏°‡πà‡∏°‡∏µ LocalStorage)
  items = normalizeArray([
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏î‡πâ)
    { id:1, itemName:"Potion", price:10, description:"Heal a bit", category:"Consumable", stack:1, stackCount:1, crafting_resources:[{AtomNumber:1, StackCount:2}] },
    { id:2, itemName:"Iron Shard", price:5, description:"Metal piece", category:"Miscellaneous", stack:1, stackCount:1, crafting_resources:[] }
  ]);
  renderList();
  if(items.length){ selected=0; $("editorBody").style.display="block"; openEditor(items[0]); renderCraft(); }
  showPreview(false);
})();
</script>
</body>
</html>
